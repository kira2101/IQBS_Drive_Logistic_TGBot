# CLAUDE.md

Этот файл предоставляет руководство для Claude Code (claude.ai/code) при работе с кодом в данном репозитории.

## Обзор проекта

Это комплексный **Telegram-бот для учета времени в логистике** для логистических компаний. Он отслеживает рабочие расписания, поездки, расход топлива и автоматически распределяет затраты по проектам/транспортным средствам. Система интегрируется с CRM Remonline и включает сложные алгоритмы распределения затрат.

## Команды разработки

### Установка и настройка
```bash
# Установка зависимостей
pip install -r requirements.txt

# Создание начальной базы данных и примеров проектов
python setup_projects.py

# Запуск бота
python bot.py
```

### Миграции базы данных
```bash
# Выполнение скриптов миграции при необходимости (ручной процесс)
python migrate_add_crm_cache.py
```

## Архитектура

### Основные компоненты

**Точка входа**: `bot.py` - Центральный Telegram-бот с обработчиками команд и callback'ов

**Слой данных**: 
- `models.py` - SQLAlchemy модели для всех сущностей
- `database.py` - Подключение к базе данных и управление сессиями

**Бизнес-логика**:
- `state_manager.py` - Управление состоянием рабочих процессов с JSON-сериализацией
- `report_generator.py` - Алгоритмы распределения затрат и генерация отчетов
- `fuel_controller.py` - Отслеживание топлива и расчеты потребления

**Интеграции**:
- `crm_remonline.py` - Интеграция с API CRM Remonline
- `crm_cache_manager.py` - Оптимизация производительности CRM с TTL кэшированием
- `crm_comment_manager.py` - Автоматические уведомления о прибытии/отправлении в CRM
- `webhook_manager.py` - Внешняя webhook-интеграция для отчетов

**Конфигурация**: `settings.py` + `settings.json` - Централизованная система конфигурации на JSON

### Иерархия модели данных

```
WorkingDay (общая рабочая сессия)
├── WorkDay (отдельные поездки/активности)
    ├── Activity (рабочие сессии, закупки)
    ├── Trip (поездки между локациями)
    └── FuelPurchase (операции с топливом с фотографиями)
```

### Ключевая бизнес-логика - Распределение затрат

Система реализует сложное распределение затрат для общих ресурсов:

- **Поездки к объектам CRM**: 100% распределяется на конкретный проект
- **Поездки домой/на склад**: Распределяется между активными проектами (с активностями)
- **Поездки в магазин**: Распределяется только между проектами с закупочными активностями
- **Поездки на заправку**: Распределяется между ВСЕМИ доступными проектами (включая проекты времени простоя)

## Система конфигурации

- **settings.json**: Конфигурации транспорта, администраторы, настройки топлива, CRM-фильтры, TTL кэша, вебхуки
- **.env**: BOT_TOKEN, DATABASE_URL, REMONLINE_API_KEY
- База данных поддерживает SQLite (по умолчанию) и PostgreSQL

## Ключевые паттерны

### Управление состоянием
- JSON-сериализованное состояние пользователя в базе данных
- Поддержка многошаговых рабочих процессов (вождение, работа, закупки и т.д.)
- Сохранение контекста между взаимодействиями

### Оптимизация производительности
- Кэширование объектов CRM с настраиваемым TTL
- Массовые операции с метаданными
- Пулы соединений

### Обработка ошибок
- Комплексное логирование ошибок
- Корректная деградация при недоступности CRM
- Аудиторские следы активности пользователей

## Важные файлы

- `USER_ACTIVITY_LOGGING.md` - Документация по логированию активности
- `photos/` - Загруженные пользователями чеки на топливо и фото одометра
- `reports/` - Сгенерированные ежедневные JSON-отчеты
- `user_logs/` - Ежедневные логи активности по пользователям

## Тестирование

Автоматизированного набора тестов в настоящее время не существует. Тестирование выполняется вручную через взаимодействие с Telegram-ботом.

## Схема базы данных

Ключевые сущности: User, Project, WorkingDay, WorkDay, Activity, Trip, FuelPurchase, CRMCache, UserState

Схема поддерживает сложные сценарии распределения затрат с иерархическими отношениями данных и внешней CRM-интеграцией.